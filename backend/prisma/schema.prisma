generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  ADMIN
  AUDITOR
  COMPLIANCE_OFFICER
  FUND_MANAGER
}

enum UserStatus {
  PENDING
  ACTIVE
  REJECTED
}

enum DocType {
  ANNUAL_REPORT
  COMPLIANCE_CERT
  RISK_DISCLOSURE
  REGULATORY_FILING
  INTERNAL_MEMO
  OTHER
}

enum DocStatus {
  PENDING
  IN_REVIEW
  APPROVED
  REJECTED
  ARCHIVED
}

enum AuditAction {
  CREATED
  STATUS_CHANGED
  TITLE_UPDATED
  FILE_UPDATED
  PERIOD_UPDATED
}

model User {
  id              String      @id @default(uuid())
  email           String      @unique
  password        String
  name            String
  role            UserRole
  status          UserStatus  @default(PENDING)
  accessibleFunds Fund[]      @relation("FundAccess")
  managedFunds    Fund[]      @relation("FundManagers") // Helper for explicit manager assignment if needed, or just rely on FundAccess
  uploads         Document[]
  auditLogs       AuditLog[]
  chatSessions    ChatSession[]

  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
}

model Fund {
  id        String     @id @default(uuid())
  code      String     @unique
  name      String
  region    String?
  currency  String?
  documents Document[]
  managers  User[]     @relation("FundManagers")
  viewers   User[]     @relation("FundAccess") // Users who have read access

  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
}

model Document {
  id           String     @id @default(uuid())
  title        String
  fundId       String
  fund         Fund       @relation(fields: [fundId], references: [id])
  type         DocType
  status       DocStatus  @default(PENDING)
  periodStart  DateTime
  periodEnd    DateTime
  description  String?
  fileKey      String
  uploadedById String
  uploadedBy   User       @relation(fields: [uploadedById], references: [id])
  auditLogs    AuditLog[]

  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
}

model AuditLog {
  id         String      @id @default(uuid())
  documentId String
  document   Document    @relation(fields: [documentId], references: [id])
  userId     String
  user       User        @relation(fields: [userId], references: [id])
  action     AuditAction
  details    Json?
  timestamp  DateTime    @default(now())
}

model ChatSession {
  id        String        @id @default(uuid())
  userId    String
  title     String        @default("New Chat")
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
  user      User          @relation(fields: [userId], references: [id])
  messages  ChatMessage[]
  
  @@index([userId])
}

model ChatMessage {
  id        String      @id @default(uuid())
  sessionId String
  role      String      // 'user' or 'assistant'
  content   String      @db.Text
  createdAt DateTime    @default(now())
  session   ChatSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  
  @@index([sessionId])
}
